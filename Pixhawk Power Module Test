/*
 * Pixhawk 90A Power Module Monitor for ESP32
 * Monitoring: Voltage (4S LiPo) and Current
 */

// --- PINS (Use ADC1 pins for better stability on ESP32) ---
const int voltPin = 34; // GPIO 34 (Connect to Power Module Voltage pin)
const int currPin = 35; // GPIO 35 (Connect to Power Module Current pin)

// --- CALIBRATION SETTINGS ---
const float V_REF = 3.30;       // ESP32 Voltage Reference
const float ADC_RES = 4095.0;   // ESP32 12-bit Resolution
const float VOLT_SCALE = 10.1;  // Standard Pixhawk Voltage Multiplier
const float CURR_SCALE = 17.0;  // Standard Amps-per-Volt (Approx 17-27 depending on module)
const int SAMPLES = 50;         // Number of samples for smoothing noise

// --- VARIABLES ---
float currentOffset = 0;
unsigned long lastTime = 0;
float totalmAh = 0;

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("\n--- Pixhawk Power Module Initializing ---");

  // 1. Auto-calibrate zero-current offset
  // IMPORTANT: Ensure the motor is OFF and no current is flowing during startup
  Serial.print("Calibrating zero-offset (Keep motor OFF)... ");
  long offsetRaw = 0;
  for(int i = 0; i < 100; i++) {
    offsetRaw += analogRead(currPin);
    delay(10);
  }
  currentOffset = (float)offsetRaw / 100.0;
  
  Serial.println("Done.");
  Serial.print("Zero Offset Raw Value: "); Serial.println(currentOffset);
  Serial.println("V (Volts) | A (Amps) | W (Watts) | mAh (Used)");
  Serial.println("----------------------------------------------");
  
  lastTime = millis();
}

void loop() {
  float rawVolt = 0;
  float rawCurr = 0;

  // 2. Sample multiple times to filter out high-frequency ESC/Motor noise
  for(int i = 0; i < SAMPLES; i++) {
    rawVolt += analogRead(voltPin);
    rawCurr += analogRead(currPin);
  }
  
  float avgRawV = rawVolt / SAMPLES;
  float avgRawC = (rawCurr / SAMPLES) - currentOffset; // Subtract the baseline noise

  // 3. Convert RAW ADC to Real Units
  // Formula: (AnalogValue * ReferenceVoltage / Resolution) * Multiplier
  float voltage = (avgRawV * V_REF / ADC_RES) * VOLT_SCALE;
  float current = (avgRawC * V_REF / ADC_RES) * CURR_SCALE;

  // Cleanup: Prevent negative current or tiny ghost readings at idle
  if (current < 0.15) current = 0; 

  float power = voltage * current;

  // 4. Track Capacity (mAh)
  unsigned long currentTime = millis();
  float deltaSeconds = (currentTime - lastTime) / 1000.0;
  totalmAh += (current * 1000.0) * (deltaSeconds / 3600.0);
  lastTime = currentTime;

  // 5. Output to Serial Monitor
  Serial.print("V: ");   Serial.print(voltage, 2);
  Serial.print("V | A: "); Serial.print(current, 2);
  Serial.print("A | W: "); Serial.print(power, 1);
  Serial.print("W | mAh: "); Serial.println(totalmAh, 1);

  delay(200); // 5Hz Refresh rate
}
