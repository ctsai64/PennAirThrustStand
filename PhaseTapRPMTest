// Note changed baud rate
// Hall Effect / Phase Sensor RPM Counter
const int hallPin = 5;          // Hall sensor or Phase sensor signal pin
volatile unsigned long pulseCount = 0;
unsigned long lastTime = 0;

// --- MOTOR CONFIGURATION ---
const int poleCount = 14;       // Total magnets in the motor (e.g., 12, 14, 22)
const int interval = 500;       // Calculate every 500ms for faster updates
// ---------------------------

float rpm = 0;
float smoothedRPM = 0;

// Interrupt Service Routine
void IRAM_ATTR countPulse() {
  pulseCount++;
}

void setup() {
  // Use INPUT_PULLUP if using an A3144 or open-collector phase sensor
  pinMode(hallPin, INPUT_PULLUP); 
  Serial.begin(115200); // Higher baud rate for high-speed data

  attachInterrupt(digitalPinToInterrupt(hallPin), countPulse, FALLING);
  Serial.println("Test Stand Ready. Measuring RPM...");
}

void loop() {
  unsigned long currentTime = millis();

  if (currentTime - lastTime >= interval) {
    // 1. Grab count safely
    noInterrupts();
    unsigned long count = pulseCount;
    pulseCount = 0;
    interrupts();

    // 2. The Math
    // Frequency (pulses per second) = count / (interval / 1000)
    // For 3-phase phase sensing: RPM = (Freq * 60) / (Poles / 2)
    
    float pulsesPerMinute = (count * 60000.0) / interval;
    float polePairs = poleCount / 2.0;
    
    rpm = pulsesPerMinute / polePairs;

    // 3. Smoothing (Simple Low-Pass Filter)
    smoothedRPM = (rpm * 0.7) + (smoothedRPM * 0.3);

    // 4. Output
    Serial.print("Raw RPM: ");
    Serial.print(rpm);
    Serial.print(" | Smoothed RPM: ");
    Serial.println(smoothedRPM);

    lastTime = currentTime;
  }
}
