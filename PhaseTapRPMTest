// ESP32 Brushless RPM Counter
const int hallPin = 14;          // Use GPIO 14 on ESP32
volatile unsigned long pulseCount = 0;
unsigned long lastTime = 0;

// --- MOTOR CONFIGURATION ---
const int poleCount = 14;       // Adjust for your motor
const int interval = 500;       
// ---------------------------

float rpm = 0;

// This attribute is REQUIRED for ESP32 interrupts
void IRAM_ATTR countPulse() {
  pulseCount++;
}

void setup() {
  // Use INPUT if you have an external voltage divider
  // Use INPUT_PULLUP if you are connecting directly (proceed with caution)
  pinMode(hallPin, INPUT_PULLUP); 
  
  Serial.begin(115200); 

  // ESP32 syntax for attaching interrupts
  attachInterrupt(digitalPinToInterrupt(hallPin), countPulse, FALLING);
  
  Serial.println("ESP32 Test Stand Ready.");
}

void loop() {
  unsigned long currentTime = millis();

  if (currentTime - lastTime >= interval) {
    noInterrupts();
    unsigned long count = pulseCount;
    pulseCount = 0;
    interrupts();

    // RPM = (Pulses_per_second * 60) / Pole_Pairs
    float pulsesPerMinute = (count * 60000.0) / interval;
    rpm = pulsesPerMinute / (poleCount / 2.0);

    Serial.printf("Motor RPM: %.0f\n", rpm);

    lastTime = currentTime;
  }
}
